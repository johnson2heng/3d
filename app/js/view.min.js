var Detector,Dylrender=function(a,b){this.width=a?a:window.innerWidth,this.height=b?b:window.innerHeight,this.models=[],this.scale=1,this.canvas=null,this.backgroundScene=null,this.backgroundCamera=null,this.scene=null,this.camera=null,this.renderer=null,this.ambientLight=null,this.directionalLight=null,this.pointLight=null,this.size=150,this.mainModel=null,this.backgroundMesh=null,this.textureCube=null,this.envmapScene=null,this.envmapCamera=null};Dylrender.prototype.Start=function(a){if(Detector.webgl||Detector.addGetWebGLMessage({parent:document.getElementById("model-container")}),!this.InitThree(a))return!1;if(!this.InitCamera())return!1;if(!this.InitLights())return!1;var b=this;return window.addEventListener("resize",function(){b.windowResize(a)},!1),this.animate(),this.canvas.addEventListener("mouseup",function(){b.controls.autoRotate=!1},!1),!0},Dylrender.prototype.InitCamera=function(){return this.camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e4),this.envmapCamera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e4),this.camera.position.set(0,0,100),this.backgroundCamera=new THREE.Camera,this.backgroundScene.add(this.backgroundCamera),this.scene.add(this.camera),this.controls=new THREE.OrbitControls(this.camera,this.canvas),this.controls.autoRotate=!0,!0},Dylrender.prototype.InitThree=function(a){if(this.canvas=a,!this.canvas||!this.canvas.getContext)return!1;this.scene=new THREE.Scene,this.backgroundScene=new THREE.Scene,this.envmapScene=new THREE.Scene;var b={canvas:this.canvas,antialias:!0,alpha:!0};return this.renderer=new THREE.WebGLRenderer(b),this.renderer?(this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.gammaInput=!0,this.renderer.gammaOutput=!0,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.cullFace=THREE.CullFaceBack,!0):!1},Dylrender.prototype.Envmap=function(){var c,d,a="/images/textures/",b=[a+"posx.jpg",a+"negx.jpg",a+"posy.jpg",a+"negy.jpg",a+"posz.jpg",a+"negz.jpg"];this.textureCube=(new THREE.CubeTextureLoader).load(b),this.textureCube.format=THREE.RGBFormat,this.textureCube.mapping=THREE.CubeReflectionMapping,c=THREE.ShaderLib["cube"],d=new THREE.ShaderMaterial({fragmentShader:c.fragmentShader,vertexShader:c.vertexShader,uniforms:c.uniforms,depthWrite:!1,side:THREE.BackSide}),d.uniforms["tCube"].value=this.textureCube,new THREE.Mesh(new THREE.BoxGeometry(100,100,100),d)},Dylrender.prototype.InitLights=function(){return this.scene.add(new THREE.HemisphereLight(4469555,1118498)),this.ambientLight=new THREE.AmbientLight(2105376),this.camera.add(this.ambientLight),this.directionalLight=new THREE.DirectionalLight(16777215,.75),this.directionalLight.position.x=1,this.directionalLight.position.y=1,this.directionalLight.position.z=2,this.directionalLight.position.normalize(),this.camera.add(this.directionalLight),this.pointLight=new THREE.PointLight(16777215,.3),this.pointLight.position.x=0,this.pointLight.position.y=-25,this.pointLight.position.z=10,this.camera.add(this.pointLight),!0},Dylrender.prototype.loadObjModel=function(a,b,c){var e,d=this,f=new THREE.OBJLoader,g=function(a){var b,c;a.lengthComputable&&(c=100*(a.loaded/a.total),console.log(Math.round(c,2)+"% downloaded")),b=a.total?(100*a.loaded/a.total).toFixed(0)+"%":Math.round(a.loaded/1024)+" KB",$("#loading-css span").text(b),$(".model-loading").show()},h=function(){};THREE.Loader.Handlers.add(/\.dds$/i,new THREE.DDSLoader),b?(e=new THREE.MTLLoader,e.setBaseUrl(c),e.setPath(c),e.load(b,function(b){b.preload(),f.setMaterials(b),f.load(a,function(a){a.castShadow=!0,a.receiveShadow=!0,a.traverse(function(a){a instanceof THREE.Mesh&&(a.geometry.center(),d.camera.position.set(0,Math.max(1.5*a.geometry.boundingBox.max.x,1.5*a.geometry.boundingBox.max.y,1.5*a.geometry.boundingBox.max.z),Math.max(3*a.geometry.boundingBox.max.x,3*a.geometry.boundingBox.max.y,3*a.geometry.boundingBox.max.z)))}),d.scene.add(a),$("#loading-css").remove()},g,h)})):f.load(a,function(a){a.castShadow=!0,a.receiveShadow=!0,a.traverse(function(a){a instanceof THREE.Mesh&&(a.material.color.setHex("#e38200".replace("#","0x")),a.geometry.center(),d.camera.position.set(0,Math.max(1.5*a.geometry.boundingBox.max.x,1.5*a.geometry.boundingBox.max.y,1.5*a.geometry.boundingBox.max.z),Math.max(3*a.geometry.boundingBox.max.x,3*a.geometry.boundingBox.max.y,3*a.geometry.boundingBox.max.z)))}),d.scene.add(a),$("#loading-css").remove()},g,h)},Dylrender.prototype.loadModel=function(a,b,c,d){var f,g,e=this;for(g=0;g<this.models.length;g++)this.scene.remove(this.models[g]),this.models.pop();"json"===a?f=new THREE.JSONLoader:"jsbin"===a?f=new THREE.BinaryLoader:"stl"===a?f=new THREE.STLLoader:alert("文件格式错误"),THREE.Loader.Handlers.add(/\.dds$/i,new THREE.DDSLoader),loadCallback=function(a,b){e.addModel(a,b,c,d),$("#loading-css").remove()},f.load(b,loadCallback,function(a){var b;b=a.total?(100*a.loaded/a.total).toFixed(0)+"%":Math.round(a.loaded/1024)+" KB",$("#loading-css span").text(b),$(".model-loading").show()})},Dylrender.prototype.addModel=function(a,b,c,d){var e,h,f=new THREE.Color,g=new THREE.Color;if(d||(d={}),f.setHex(c.replace("#","0x")),d.specular?g.setHex(d.specular.replace("#","0x")):g.setHex("0x111111"),d={color:f.getHex(),specular:g.getHex(),shininess:d.shininess?d.shininess:"30"},a instanceof THREE.BufferGeometry&&(a=(new THREE.Geometry).fromBufferGeometry(a)),"Geometry"==a.type){if(a.computeBoundingBox(),a.center(),!b||b.length<2)b=new THREE.MeshPhongMaterial({color:d.color,specular:d.specular,shininess:d.shininess,side:THREE.DoubleSide,shading:THREE.SmoothShading}),e=new THREE.Mesh(a,b),e.rotation.set(-Math.PI/2,0,-Math.PI/4);else{for(b=new THREE.MultiMaterial(b),h=0;h<b.materials.length;h++);e=new THREE.Mesh(a,b)}this.directionalLight.position.x=2*a.boundingBox.min.y,this.directionalLight.position.y=2*a.boundingBox.min.y,this.directionalLight.position.z=2*a.boundingBox.max.z,this.pointLight.position.x=(a.boundingBox.min.y+a.boundingBox.max.y)/2,this.pointLight.position.y=(a.boundingBox.min.y+a.boundingBox.max.y)/2,this.pointLight.position.z=2*a.boundingBox.max.z,this.camera.position.set(0,Math.max(1.5*a.boundingBox.max.x,1.5*a.boundingBox.max.y,1.5*a.boundingBox.max.z),Math.max(3*a.boundingBox.max.x,3*a.boundingBox.max.y,3*a.boundingBox.max.z))}e.castShadow=!0,e.receiveShadow=!0,a.computeFaceNormals(),this.mainModel=e,this.scene.add(e)},Dylrender.prototype.windowResize=function(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.envmapCamera.aspect=window.innerWidth/window.innerHeight,this.envmapCamera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)},Dylrender.prototype.animate=function(){var a=this;requestAnimationFrame(function(){a.animate()}),this.render()},Dylrender.prototype.render=function(){this.controls.update(),this.renderer.autoClear=!1,this.envmapCamera.rotation.copy(this.camera.rotation),this.renderer.clear(),this.renderer.render(this.backgroundScene,this.backgroundCamera),this.renderer.render(this.scene,this.camera)},Dylrender.prototype.MeshCount=function(){var a=0;return this.scene.traverse(function(b){b instanceof THREE.Mesh&&(a+=1)}),a},Dylrender.prototype.VertexCount=function(){var a=0;return this.scene.traverse(function(b){b instanceof THREE.Mesh&&(a+=b.geometry.vertices.length)}),a},Dylrender.prototype.FaceCount=function(){var a=0;return this.scene.traverse(function(b){b instanceof THREE.Mesh&&(a+=b.geometry.faces.length)}),a},Dylrender.prototype.GetMesh=function(a){var d,b=null,c=0;for(d=0;d<this.scene.children.length;d++)if(b=this.scene.children[d],b instanceof THREE.Mesh){if(c==a)return b;c+=1}return null},Dylrender.prototype.AddMeshes=function(a){var b;for(b=0;b<a.length;b++)this.scene.add(a[b])},Dylrender.prototype.RemoveMesh=function(a){this.scene.remove(a),this.DrawIfNeeded()},Dylrender.prototype.RemoveMeshes=function(){var a,b;for(b=0;b<this.scene.children.length;b++)a=this.scene.children[b],a instanceof THREE.Mesh&&(this.scene.remove(a),b--);this.DrawIfNeeded()},Dylrender.prototype.SetCamera=function(a,b,c){this.navigation.SetCamera(a,b,c),this.navigation.SetOrbitCenter(b.Clone()),this.DrawIfNeeded()},Dylrender.prototype.SetClearColor=function(a){this.renderer.setClearColor(new THREE.Color(a)),this.DrawIfNeeded()},Dylrender.prototype.ChangeColor=function(a){var b=/^#[0-9a-fA-F]{6}$/;b.test(a)?this.mainModel.material.color.setHex(a.replace("#","0x")):alert("无效的颜色值")},Dylrender.prototype.ChangeSpecular=function(a){var b=/^#[0-9a-fA-F]{6}$/;b.test(a)?(this.mainModel.material.specular.setHex(a.replace("#","0x")),console.log(this.mainModel.material.specular),this.DrawIfNeeded()):alert("无效的颜色值")},Dylrender.prototype.LoadImage=function(a){var b=THREE.ImageUtils.loadTexture(a);b.minFilter=THREE.LinearFilter,this.backgroundMesh=new THREE.Mesh(new THREE.PlaneGeometry(2,2,0),new THREE.MeshBasicMaterial({map:b})),this.backgroundMesh.material.depthTest=!1,this.backgroundMesh.material.depthWrite=!1,this.backgroundScene.add(this.backgroundMesh),b.needsUpdate=!0},Dylrender.prototype.ChangeBackground=function(a){this.backgroundMesh.material.map.image.src=a,this.backgroundMesh.material.map.needsUpdate=!0},Dylrender.prototype.SetShininess=function(a){2==a?this.mainModel.material.wireframe=!0:(this.mainModel.material.wireframe=!1,this.mainModel.material.shininess=1==a?30:0,null!=this.mainModel&&(this.mainModel.geometry.normalsNeedUpdate=!0))},Dylrender.prototype.ChangeShininess=function(a){this.mainModel.material.shininess=a,this.DrawIfNeeded()},Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var a=document.createElement("canvas");return!(!window.WebGLRenderingContext||!a.getContext("webgl")&&!a.getContext("experimental-webgl"))}catch(b){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var a=document.createElement("div");return a.id="webgl-error-message",this.webgl||(a.innerHTML=window.WebGLRenderingContext?['<i style="font-size: 48px" class="icondyl" style="color: #fff">&#xe60b;</i><br />Your graphics card does not seem to support <a target="_parent" href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#f00">WebGL</a>.<br />','Find out how to get it <a target="_parent" href="http://get.webgl.org/" style="color:#f00">here</a>.<br /><br />','很抱歉，您的显卡不支持或浏览器未开启 <a target="_parent" href="http://get.webgl.org/" style="color:#f00">3D渲染效果</a>.<br />','请升级您的浏览器至 Chrome谷歌浏览器、火狐浏览器等其他非IE浏览器.<br/><a target="_parent" style="color:#f00;font-size:28px;padding-top:20px" href="http://rj.baidu.com/soft/detail/14744.html?ald">谷歌浏览器下载地址</a><br />',"如果使用谷歌浏览器依然无法使用3D渲染，请联系网站技术客服帮您解决！"].join("\n"):['<i style="font-size: 48px" class="icondyl" style="color: #fff">&#xe60b;</i><br />Your browser does not seem to support <a target="_parent" href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#f00">WebGL</a>.<br/>','Find out how to get it <a target="_parent" href="http://get.webgl.org/" style="color:#f00">here</a>.<br /><br />','很抱歉，您的浏览器太老了，不支持 <span style="color:#f00">3D渲染效果</span>.<br />','请升级您的浏览器至 Chrome谷歌浏览器、火狐浏览器、360浏览器、QQ浏览器等其他非IE浏览器.<br/><a target="_parent" style="color:#f00;font-size:28px;padding-top:20px" href="http://rj.baidu.com/soft/detail/14744.html?ald">谷歌浏览器下载地址</a>'].join("\n")),a},addGetWebGLMessage:function(a){var b,c,d;a=a||{},b=void 0!==a.parent?a.parent:document.body,c=void 0!==a.id?a.id:"oldie",d=Detector.getWebGLErrorMessage(),d.id=c,b.appendChild(d)}},function(){"use strict";var a="undefined"!=typeof module&&module.exports,b="undefined"!=typeof Element&&"ALLOW_KEYBOARD_INPUT"in Element,c=function(){for(var a,b,c=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],d=0,e=c.length,f={};e>d;d++)if(a=c[d],a&&a[1]in document){for(d=0,b=a.length;b>d;d++)f[c[0][d]]=a[d];return f}return!1}(),d={request:function(a){var d=c.requestFullscreen;a=a||document.documentElement,/5\.1[\.\d]* Safari/.test(navigator.userAgent)?a[d]():a[d](b&&Element.ALLOW_KEYBOARD_INPUT)},exit:function(){document[c.exitFullscreen]()},toggle:function(a){this.isFullscreen?this.exit():this.request(a)},raw:c};return c?(Object.defineProperties(d,{isFullscreen:{get:function(){return Boolean(document[c.fullscreenElement])}},element:{enumerable:!0,get:function(){return document[c.fullscreenElement]}},enabled:{enumerable:!0,get:function(){return Boolean(document[c.fullscreenEnabled])}}}),a?module.exports=d:window.screenfull=d,void 0):(a?module.exports=!1:window.screenfull=!1,void 0)}();